<!DOCTYPE html>
<html>
<head>
<style>
body { background: #333; color: #eee; }

.lyric {
  position: relative;
  white-space: nowrap;
  color: lightblue;
  text-shadow: 0 0 3px rgba(0,0,0,1); 
}

.lyric::after {
  content: attr(data-text);
  position: absolute;
  left: 0;
  top: 0;
  color: red;
  overflow: hidden;
  width: 40%;
  /* animation: run-text 5s infinite linear; */
  text-shadow: 0 0 3px rgba(255,255,255,1); 
}

@keyframes run-text {
  from { width: 0 }
  to { width: 100% }
}

</style>
</head>
<body>
    <div id="app" class="container">
        blah
        <div v-if="state == 'init'">
            <div>
                Enter a nickname:
                <input type="text" v-model="nickname" />
                <button v-on:click="start">Start!</button>
            </div>
        </div>
        <div v-if="state == 'home'">
            <div>{{nickname}}</div>
            <div>
                <input type="text" v-model="search" />
            </div>
            <div>
                <ul>
                    <li v-for="song in songResults">
                        <strong>{{ song.title }}</strong>
                        <em>{{ song.artist }}</em>
                        <button v-on:click="enqueue(song)">Sing it!</button>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script src="js/vue.js" language="javascript"></script>

    <script language="javascript">

        function postJson(url, body) {
            return fetch(url, { headers: { "Content-Type": "application/json; charset=utf-8" }, method: 'POST', body: JSON.stringify(body) });
        }

        var app = new Vue({
            el: '#app',
            data: {
                state: 'init',
                search: '',
                nickname: '',
                songResults: [],
                singerId: null
            },
            methods: {
                start: async function (event) {
                    if (this.nickname.trim() != '') {
                        var result = await postJson('/join', { nickname: this.nickname });
                        if (result.ok) {
                            var data = await result.json();
                            this.singerId = data.singerId;
                            this.state = 'home';
                        }
                    }
                },

                doSearch: async function (val, oldVal) {
                    if (typeof (val) == 'string' && val.trim().length > 0 && val != oldVal) {
                        var result = await fetch('/search?' + new URLSearchParams({ query: val.trim() }))
                        if (result.ok) {
                            this.songResults = await result.json();
                        }
                    }
                },

                enqueue: async function(song) {
                    var result = await postJson('/addsong', { singerId: this.singerId, songId: song.id } );
                }

                
            },
            watch: {
                search: function (val, oldVal) {
                    this.doSearch(val, oldVal);
                }
            }
        });

    </script>
</body>
</html>